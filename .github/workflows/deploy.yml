name: Deploy to Raspberry Pi Zero 2 (ZeroTier)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Instalacja .NET
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # 2. Budowanie aplikacji
    - name: Publish Application
      run: |
        dotnet publish ./TailorWebsite.Web/TailorWebsite.Web.csproj \
        -c Release \
        -r linux-arm64 \
        --self-contained true \
        -p:PublishSingleFile=true \
        -o ./publish

    # --- TO JEST TEN BRAKUJĄCY ELEMENT! ---
    # GitHub musi dołączyć do Twojej sieci VPN
    - name: Join ZeroTier Network
      uses: zerotier/github-action@v1
      with:
        network_id: ${{ secrets.ZEROTIER_NETWORK_ID }}
        auth_token: ${{ secrets.ZEROTIER_CENTRAL_TOKEN }}

    # Czekamy 30s, żeby połączenie się ustabilizowało
    - name: Wait for ZeroTier connection
      run: sleep 30
    
    # Test połączenia (żebyś widział w logach czy działa)
    - name: Ping Raspberry Pi
      run: ping -c 5 ${{ secrets.RPI_HOST }}
    # --------------------------------------

    # 3. Kopiowanie plików (z wydłużonym czasem oczekiwania)
    - name: Copy files via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.RPI_HOST }}
        username: ${{ secrets.RPI_USER }}
        key: ${{ secrets.RPI_SSH_KEY }}
        port: 22
        timeout: 2m               
        source: "./publish/*"
        target: "/home/pi/tailor-app"
        strip_components: 1

    # 4. Restart usługi
    - name: Restart Service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.RPI_HOST }}
        username: ${{ secrets.RPI_USER }}
        key: ${{ secrets.RPI_SSH_KEY }}
        port: 22
        timeout: 2m
        script: |
          chmod +x /home/pi/tailor-app/TailorWebsite.Web
          sudo systemctl restart tailor.service
          
